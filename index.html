<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Visualiseur Compression Audio Simplifi√©</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #000;
  color: #eee;
}
.grid-container {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 20px;
}
.controls, #compGraphContainer {
  background: #111;
  padding: 10px;
  border: 1px solid #555;
  border-radius: 5px;
  margin-bottom: 10px;
}
.controls label {
  display: inline-block;
  width: 80px;
}
.controls input[type="range"], .controls input[type="number"] {
  width: 150px;
}
button {
  margin: 5px 5px 5px 0;
  padding: 5px 10px;
}
canvas {
  border: 1px solid #555;
  background: #111;
  display: block;
  margin: 10px 0;
}
.waveform-container {
  display: flex;
  flex-direction: column;
}
.zoom-nav {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
#grMeter {
  width: 20px !important;
  height: 280px !important;
  margin-left: 10px;
}
.flex-graph {
  display: flex;
  align-items: flex-start;
}
</style>
</head>
<body>

<h2>Visualiseur de Compression Audio</h2>
<input type="file" id="fileInput" accept="audio/*"><br><br>

<div class="grid-container">
  <!-- Partie gauche -->
  <div>
    <div class="controls">
      <label>Threshold:</label>
      <input type="range" id="threshold" min="-60" max="0" value="0" step="1">
      <span id="threshVal">0 dB</span><br>

      <label>Ratio:</label>
      <input type="range" id="ratio" min="1" max="20" value="1" step="0.5">
      <span id="ratioVal">1:1</span><br>

      <label>Attack:</label>
      <input type="range" id="attack" min="0" max="1" step="0.01" value="0">
      <span id="attackVal">0 s</span><br>

      <label>Release:</label>
      <input type="range" id="release" min="0" max="1" step="0.01" value="0">
      <span id="releaseVal">0 s</span><br>

      <label>Makeup:</label>
      <input type="range" id="makeup" min="0" max="24" value="0" step="1">
      <span id="makeupVal">0 dB</span><br><br>

      <button id="playPause">‚ñ∂Ô∏è Lecture</button>
      <button id="loopBtn">üîÅ Boucle ON</button>
    </div>

    <div class="flex-graph">
      <div id="compGraphContainer">
        <h3>Courbe de transfert</h3>
        <canvas id="compGraph" width="280" height="280"></canvas>
      </div>
      <canvas id="grMeter" width="20" height="280"></canvas>
    </div>
  </div>

  <!-- Partie droite -->
  <div class="waveform-container">
    <div class="zoom-nav">
      <label>Zoom:</label>
      <input type="range" id="zoom" min="1" max="20" value="1" step="1">
      <span id="zoomVal">1x</span>

      <label>Position:</label>
      <input type="range" id="position" min="0" max="100" value="0" step="1">
      <span id="posVal">0%</span>
    </div>

    <h3>Original</h3>
    <canvas id="canvasOriginal" width="900" height="150"></canvas>

    <h3>Compress√©</h3>
    <canvas id="canvasCompressed" width="900" height="150"></canvas>
  </div>
</div>

<script>
let audioContext, buffer, sourceNode, compressorNode, makeupNode;
let isPlaying = false, loopEnabled = true;
let analyserNode;
let samples, compressedSamples;

// DOM
const fileInput = document.getElementById("fileInput");
const playPauseBtn = document.getElementById("playPause");
const loopBtn = document.getElementById("loopBtn");

const threshSlider = document.getElementById("threshold");
const ratioSlider = document.getElementById("ratio");
const attackSlider = document.getElementById("attack");
const releaseSlider = document.getElementById("release");
const makeupSlider = document.getElementById("makeup");

const zoomSlider = document.getElementById("zoom");
const posSlider = document.getElementById("position");

const canvasOriginal = document.getElementById("canvasOriginal");
const canvasCompressed = document.getElementById("canvasCompressed");
const grCanvas = document.getElementById("grMeter");
const compGraph = document.getElementById("compGraph");

const ctxOrig = canvasOriginal.getContext("2d");
const ctxComp = canvasCompressed.getContext("2d");
const ctxGR = grCanvas.getContext("2d");
const ctxGraph = compGraph.getContext("2d");

fileInput.addEventListener("change", handleFile);
playPauseBtn.addEventListener("click", togglePlay);
loopBtn.addEventListener("click", toggleLoop);
[threshSlider, ratioSlider, attackSlider, releaseSlider, makeupSlider].forEach(ctrl => ctrl.addEventListener("input", updateCompressor));
zoomSlider.addEventListener("input", redraw);
posSlider.addEventListener("input", redraw);

// --- Fonctions ---
async function handleFile(e){
  const file = e.target.files[0];
  if(!file) return;
  if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

  // R√©initialiser les param√®tres
  threshSlider.value=0; ratioSlider.value=1;
  attackSlider.value=0; releaseSlider.value=0; makeupSlider.value=0;
  updateCompressorValuesDisplay();

  const arrayBuffer = await file.arrayBuffer();
  buffer = await audioContext.decodeAudioData(arrayBuffer);

  samples = buffer.getChannelData(0);
  compressedSamples = samples.slice();

  drawWaveform(ctxOrig, samples, 1,0,canvasOriginal,"#44ccff");
  drawWaveform(ctxComp, compressedSamples, 1,0,canvasCompressed,"#ff8844");

  updateCompressor();
}

function togglePlay(){
  if(isPlaying){
    sourceNode.stop();
    isPlaying=false;
    playPauseBtn.textContent="‚ñ∂Ô∏è Lecture";
  } else {
    playSource();
  }
}

function playSource(){
  sourceNode = audioContext.createBufferSource();
  sourceNode.buffer = buffer;
  sourceNode.loop = loopEnabled;

  compressorNode = audioContext.createDynamicsCompressor();
  makeupNode = audioContext.createGain();

  applyCompressorSettings();

  analyserNode = audioContext.createAnalyser();
  analyserNode.fftSize=2048;

  sourceNode.connect(compressorNode);
  compressorNode.connect(makeupNode);
  makeupNode.connect(analyserNode);
  analyserNode.connect(audioContext.destination);

  sourceNode.start(0);
  isPlaying=true;
  playPauseBtn.textContent="‚è∏ Pause";

  drawGRRealtime();
}

function applyCompressorSettings(){
  if(!compressorNode || !makeupNode) return;
  compressorNode.threshold.value = parseFloat(threshSlider.value);
  compressorNode.ratio.value = parseFloat(ratioSlider.value);
  compressorNode.attack.value = parseFloat(attackSlider.value);
  compressorNode.release.value = parseFloat(releaseSlider.value);
  makeupNode.gain.value = Math.pow(10,parseFloat(makeupSlider.value)/20);
}

function updateCompressor(){
  updateCompressorValuesDisplay();
  applyCompressorSettings();
  redraw();
  drawCompGraph();
}

function updateCompressorValuesDisplay(){
  document.getElementById("threshVal").textContent=threshSlider.value+" dB";
  document.getElementById("ratioVal").textContent=ratioSlider.value+":1";
  document.getElementById("attackVal").textContent=attackSlider.value+" s";
  document.getElementById("releaseVal").textContent=releaseSlider.value+" s";
  document.getElementById("makeupVal").textContent=makeupSlider.value+" dB";
}

function redraw(){
  const zoom = parseInt(zoomSlider.value);
  const pos = parseInt(posSlider.value)/100;
  document.getElementById("zoomVal").textContent=zoom+"x";
  document.getElementById("posVal").textContent=Math.round(pos*100)+"%";
  drawWaveform(ctxOrig, samples, zoom, pos, canvasOriginal,"#44ccff");
  drawWaveform(ctxComp, compressedSamples, zoom, pos, canvasCompressed,"#ff8844");
}

function drawWaveform(ctx,data,zoom,pos,canvas,color){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!data) return;
  const segmentLength = Math.floor(data.length/zoom);
  const start = Math.floor(pos*(data.length-segmentLength));
  const end = Math.min(start+segmentLength, data.length);
  const step = Math.max(1, Math.floor((end-start)/canvas.width));
  const amp = canvas.height/2;
  ctx.beginPath();
  for(let i=0;i<canvas.width;i++){
    const segStart=start+i*step;
    let min=1,max=-1;
    for(let j=0;j<step;j++){
      const s=data[segStart+j]||0;
      if(s<min) min=s;
      if(s>max) max=s;
    }
    ctx.moveTo(i,amp+min*amp);
    ctx.lineTo(i,amp+max*amp);
  }
  ctx.strokeStyle=color;
  ctx.stroke();
  ctx.fillStyle="#888";
  ctx.font="12px Arial";
  for(let t=0;t<=10;t++){
    const x = t/10*canvas.width;
    const sec = ((start + t*segmentLength/10)/buffer.sampleRate).toFixed(2);
    ctx.fillText(sec+"s",x,canvas.height-2);
  }
}

function drawCompGraph(){
  ctxGraph.clearRect(0,0,compGraph.width,compGraph.height);
  const threshold=parseFloat(threshSlider.value);
  const ratio=parseFloat(ratioSlider.value);
  const makeUp=parseFloat(makeupSlider.value);
  const width=compGraph.width;
  const height=compGraph.height;
  const threshX=(threshold+60)/60*width;

  ctxGraph.strokeStyle="#ff0";
  ctxGraph.beginPath();
  ctxGraph.moveTo(threshX,0);
  ctxGraph.lineTo(threshX,height);
  ctxGraph.stroke();

  ctxGraph.strokeStyle="#0f0";
  ctxGraph.beginPath();
  for(let x=0;x<=width;x++){
    let input=x/width*60-60;
    let output;
    if(input<threshold) output=input+makeUp;
    else output=threshold+(input-threshold)/ratio+makeUp;
    const y=height-((output+60)/60)*height;
    if(x===0) ctxGraph.moveTo(x,y); else ctxGraph.lineTo(x,y);
  }
  ctxGraph.stroke();
}

function drawGRRealtime(){
  requestAnimationFrame(drawGRRealtime);
  ctxGR.clearRect(0,0,grCanvas.width,grCanvas.height);
  if(!compressorNode) return;
  let reduction = compressorNode.reduction ? -compressorNode.reduction : 0;
  const h = (reduction/60)*grCanvas.height;
  ctxGR.fillStyle="#ff0000";
  ctxGR.fillRect(0,grCanvas.height-h,grCanvas.width,h);
}

function toggleLoop(){
  loopEnabled=!loopEnabled;
  loopBtn.textContent=loopEnabled?"üîÅ Boucle ON":"‚û°Ô∏è Boucle OFF";
  if(sourceNode) sourceNode.loop=loopEnabled;
}
</script>
</body>
</html>
