<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Visualiseur Compression Audio Avanc√©</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #000;
  color: #eee;
}
.grid-container {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 20px;
}
.controls, #compGraphContainer {
  background: #111;
  padding: 10px;
  border: 1px solid #555;
  border-radius: 5px;
  margin-bottom: 10px;
}
.controls label {
  display: inline-block;
  width: 80px;
}
.controls input[type="range"], .controls input[type="number"] {
  width: 150px;
}
button {
  margin: 5px 5px 5px 0;
  padding: 5px 10px;
}
canvas {
  border: 1px solid #555;
  background: #111;
  display: block;
  margin: 10px 0;
}
.zoom-nav {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.flex-graph {
  display: flex;
  align-items: flex-start;
}
#grMeter {
  width: 20px !important;
  height: 280px !important;
  margin-left: 10px;
}
</style>
</head>
<body>

<h2>Visualiseur de Compression Audio</h2>
<input type="file" id="fileInput" accept="audio/*"><br><br>

<div class="grid-container">
  <!-- Partie gauche -->
  <div>
    <div class="controls">
      <label>Threshold:</label>
      <input type="range" id="threshold" min="-60" max="0" value="0" step="1">
      <span id="threshVal">0 dB</span><br>

      <label>Ratio:</label>
      <input type="range" id="ratio" min="1" max="20" value="1" step="0.5">
      <span id="ratioVal">1:1</span><br>

      <label>Attack:</label>
      <input type="range" id="attack" min="0" max="100" value="0">
      <span id="attackVal">0 ms</span><br>

      <label>Release:</label>
      <input type="range" id="release" min="0" max="100" value="0">
      <span id="releaseVal">0 ms</span><br>

      <label>Makeup:</label>
      <input type="range" id="makeup" min="0" max="24" value="0" step="1">
      <span id="makeupVal">0 dB</span><br><br>

      <button id="playPause">‚ñ∂Ô∏è Lecture</button>
      <button id="loopBtn">üîÅ Boucle ON</button>
    </div>

    <div class="flex-graph">
      <div id="compGraphContainer">
        <h3>Courbe de transfert</h3>
        <canvas id="compGraph" width="280" height="280"></canvas>
      </div>
      <canvas id="grMeter" width="20" height="280"></canvas>
    </div>
  </div>

  <!-- Partie droite -->
  <div class="waveform-container">
    <div class="zoom-nav">
      <label>Zoom:</label>
      <input type="range" id="zoom" min="1" max="20" value="1" step="1">
      <span id="zoomVal">1x</span>

      <label>Position:</label>
      <input type="range" id="position" min="0" max="100" value="0" step="1">
      <span id="posVal">0%</span>
    </div>

    <h3>Waveform</h3>
    <canvas id="canvasWaveform" width="900" height="600"></canvas>
  </div>
</div>

<script>
let audioContext, buffer, sourceNode, compressorNode, gainNode, analyserNode, scriptNode;
let isPlaying = false, loopEnabled = true;
let samples;
let currentGR = 0;

const fileInput = document.getElementById("fileInput");
const playPauseBtn = document.getElementById("playPause");
const loopBtn = document.getElementById("loopBtn");

const threshSlider = document.getElementById("threshold");
const ratioSlider = document.getElementById("ratio");
const attackSlider = document.getElementById("attack");
const releaseSlider = document.getElementById("release");
const makeupSlider = document.getElementById("makeup");

const zoomSlider = document.getElementById("zoom");
const posSlider = document.getElementById("position");

const canvasWaveform = document.getElementById("canvasWaveform");
const grCanvas = document.getElementById("grMeter");
const compGraph = document.getElementById("compGraph");

const ctxWaveform = canvasWaveform.getContext("2d");
const ctxGR = grCanvas.getContext("2d");
const ctxGraph = compGraph.getContext("2d");

// Conversion non lin√©aire sliders attack/release
function sliderToMs(value){
    const min=0.1;
    const max=1000;
    const normalized = value/100;
    return min*Math.pow(max/min, normalized);
}

fileInput.addEventListener("change", handleFile);
playPauseBtn.addEventListener("click", togglePlay);
loopBtn.addEventListener("click", toggleLoop);

threshSlider.addEventListener("input", updateCompressor);
ratioSlider.addEventListener("input", updateCompressor);
makeupSlider.addEventListener("input", updateCompressor);

attackSlider.addEventListener("input",()=>{
    document.getElementById("attackVal").textContent=Math.round(sliderToMs(attackSlider.value))+" ms";
    applyCompressorSettings();
});
releaseSlider.addEventListener("input",()=>{
    document.getElementById("releaseVal").textContent=Math.round(sliderToMs(releaseSlider.value))+" ms";
    applyCompressorSettings();
});

zoomSlider.addEventListener("input", redraw);
posSlider.addEventListener("input", redraw);

async function handleFile(e){
  const file = e.target.files[0];
  if(!file) return;
  if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

  // R√©initialiser param√®tres
  threshSlider.value=0; ratioSlider.value=1;
  attackSlider.value=0; releaseSlider.value=0; makeupSlider.value=0;
  updateCompressorValuesDisplay();

  const arrayBuffer = await file.arrayBuffer();
  buffer = await audioContext.decodeAudioData(arrayBuffer);
  samples = buffer.getChannelData(0).slice();

  redraw();
  updateCompressor();
  if(isPlaying) playSource();
}

function togglePlay(){
  if(isPlaying){
    sourceNode.stop();
    scriptNode.disconnect();
    isPlaying=false;
    playPauseBtn.textContent="‚ñ∂Ô∏è Lecture";
  } else {
    playSource();
  }
}

function playSource(){
  if(!buffer) return;
  if(sourceNode) sourceNode.stop();

  sourceNode = audioContext.createBufferSource();
  sourceNode.buffer = buffer;
  sourceNode.loop = loopEnabled;

  compressorNode = audioContext.createDynamicsCompressor();
  applyCompressorSettings();

  gainNode = audioContext.createGain();
  gainNode.gain.value = Math.pow(10,parseFloat(makeupSlider.value)/20);

  analyserNode = audioContext.createAnalyser();
  analyserNode.fftSize = 2048;

  // ScriptProcessorNode pour calculer GR
  scriptNode = audioContext.createScriptProcessor(512,1,1);
  let env = 0;
  scriptNode.onaudioprocess = (e)=>{
      const input = e.inputBuffer.getChannelData(0);
      let maxGain = 0;
      const threshold = parseFloat(threshSlider.value);
      const ratio = parseFloat(ratioSlider.value);
      const attack = sliderToMs(parseFloat(attackSlider.value))/1000;
      const release = sliderToMs(parseFloat(releaseSlider.value))/1000;
      for(let i=0;i<input.length;i++){
          let dbSample = 20*Math.log10(Math.abs(input[i])+1e-8);
          let gainDb = 0;
          if(dbSample>threshold){
              gainDb = threshold + (dbSample-threshold)/ratio - dbSample;
          }
          const coeff = (gainDb < env) 
                        ? Math.exp(-1/(audioContext.sampleRate*attack || 1e-3))
                        : Math.exp(-1/(audioContext.sampleRate*release || 1e-3));
          env = env*coeff + gainDb*(1-coeff);
          if(env < maxGain) maxGain = env;
      }
      currentGR = maxGain; // valeur n√©gative
  };

  sourceNode.connect(compressorNode);
  compressorNode.connect(gainNode);
  gainNode.connect(analyserNode);
  analyserNode.connect(scriptNode);
  scriptNode.connect(audioContext.destination);
  gainNode.connect(audioContext.destination);

  sourceNode.start(0);
  isPlaying=true;
  playPauseBtn.textContent="‚è∏ Pause";

  drawGRRealtime();
}

function applyCompressorSettings(){
  if(!compressorNode || !gainNode) return;
  compressorNode.threshold.value = parseFloat(threshSlider.value);
  compressorNode.ratio.value = parseFloat(ratioSlider.value);
  compressorNode.attack.value = sliderToMs(parseFloat(attackSlider.value))/1000;
  compressorNode.release.value = sliderToMs(parseFloat(releaseSlider.value))/1000;
  gainNode.gain.value = Math.pow(10,parseFloat(makeupSlider.value)/20);
}

function updateCompressor(){
  updateCompressorValuesDisplay();
  applyCompressorSettings();
  redraw();
  drawCompGraph();
}

function updateCompressorValuesDisplay(){
  document.getElementById("threshVal").textContent=threshSlider.value+" dB";
  document.getElementById("ratioVal").textContent=ratioSlider.value+":1";
  document.getElementById("attackVal").textContent=Math.round(sliderToMs(attackSlider.value))+" ms";
  document.getElementById("releaseVal").textContent=Math.round(sliderToMs(releaseSlider.value))+" ms";
  document.getElementById("makeupVal").textContent=makeupSlider.value+" dB";
}

function drawGRRealtime(){
  requestAnimationFrame(drawGRRealtime);
  ctxGR.clearRect(0,0,grCanvas.width,grCanvas.height);
  const height = grCanvas.height;
  const y = ( -currentGR / 60 ) * height; // 0 dB en haut, descend
  ctxGR.fillStyle="red";
  ctxGR.fillRect(0,0,grCanvas.width,y);
}

// Ici tu peux conserver ton code redraw et drawCombinedWaveform, en tenant compte de gainNode.gain pour la waveform compress√©e

function toggleLoop(){
  loopEnabled = !loopEnabled;
  loopBtn.textContent = loopEnabled ? "üîÅ Boucle ON":"üîÅ Boucle OFF";
  if(sourceNode) sourceNode.loop = loopEnabled;
}
</script>

</body>
</html>
