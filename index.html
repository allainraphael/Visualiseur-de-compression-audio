<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Visualiseur de compression audio</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; margin:0; display:flex; height:100vh; }
    #left { width:35%; padding:10px; box-sizing:border-box; display:flex; flex-direction:column; }
    #right { flex:1; display:flex; flex-direction:column; }
    canvas { background:#000; border:1px solid #444; margin-top:10px; }
    .slider-container { margin:5px 0; }
    label { display:block; font-size:14px; }
    #controls { margin-bottom:10px; }
    #zoomControls { display:flex; gap:10px; margin-bottom:5px; }
    #grMeter { width:40px; height:150px; background:#222; border:1px solid #555; position:relative; }
    #grFill { position:absolute; bottom:0; left:0; right:0; background:#0f0; height:0%; }
  </style>
</head>
<body>
  <div id="left">
    <div id="controls">
      <div class="slider-container">
        <label>Threshold: <span id="threshVal">0 dB</span></label>
        <input type="range" id="threshold" min="-60" max="0" value="0" step="1">
      </div>
      <div class="slider-container">
        <label>Ratio: <span id="ratioVal">1:1</span></label>
        <input type="range" id="ratio" min="1" max="20" value="1" step="0.1">
      </div>
      <div class="slider-container">
        <label>Attack (ms): <span id="attackVal">0</span></label>
        <input type="range" id="attack" min="0" max="1000" value="0" step="1">
      </div>
      <div class="slider-container">
        <label>Release (ms): <span id="releaseVal">0</span></label>
        <input type="range" id="release" min="0" max="2000" value="0" step="1">
      </div>
      <div class="slider-container">
        <label>Make-up Gain: <span id="makeupVal">0 dB</span></label>
        <input type="range" id="makeup" min="0" max="24" value="0" step="0.1">
      </div>
    </div>
    <canvas id="transfer" width="300" height="200"></canvas>
    <div style="display:flex;align-items:center;gap:10px;">
      <div id="grMeter"><div id="grFill"></div></div>
      <span>GR (dB)</span>
    </div>
  </div>

  <div id="right">
    <div id="zoomControls">
      <button id="zoomIn">Zoom +</button>
      <button id="zoomOut">Zoom -</button>
      <input type="range" id="position" min="0" max="100" value="0" step="1" style="flex:1;">
    </div>
    <canvas id="waveform" width="900" height="400"></canvas>
    <div style="margin:10px;">
      <input type="file" id="fileInput">
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
    </div>
  </div>

<script>
let audioContext, sourceNode, analyserNode, compressorNode, makeupGainNode, scriptNode;
let audioBuffer, data, compressedData;
let isPlaying=false;
let zoom=1, position=0;
let animationId;

// sliders
const thresholdSlider=document.getElementById("threshold");
const ratioSlider=document.getElementById("ratio");
const attackSlider=document.getElementById("attack");
const releaseSlider=document.getElementById("release");
const makeupSlider=document.getElementById("makeup");

const threshVal=document.getElementById("threshVal");
const ratioVal=document.getElementById("ratioVal");
const attackVal=document.getElementById("attackVal");
const releaseVal=document.getElementById("releaseVal");
const makeupVal=document.getElementById("makeupVal");

function updateLabels(){
  threshVal.textContent=thresholdSlider.value+" dB";
  ratioVal.textContent=ratioSlider.value+":1";
  attackVal.textContent=attackSlider.value;
  releaseVal.textContent=releaseSlider.value;
  makeupVal.textContent=makeupSlider.value+" dB";
}
[thresholdSlider,ratioSlider,attackSlider,releaseSlider,makeupSlider].forEach(s=>s.addEventListener("input",()=>{
  updateLabels();
  updateCompressor();
}));

function updateCompressor(){
  if(compressorNode){
    compressorNode.threshold.value=parseFloat(thresholdSlider.value);
    compressorNode.ratio.value=parseFloat(ratioSlider.value);
    compressorNode.attack.value=parseFloat(attackSlider.value)/1000;
    compressorNode.release.value=parseFloat(releaseSlider.value)/1000;
  }
  if(makeupGainNode){
    makeupGainNode.gain.value=Math.pow(10, parseFloat(makeupSlider.value)/20);
  }
  drawTransfer();
}
updateLabels();

function drawTransfer(){
  const canvas=document.getElementById("transfer");
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#0f0";
  ctx.beginPath();
  const thr=parseFloat(thresholdSlider.value);
  const ratio=parseFloat(ratioSlider.value);
  for(let x=-60;x<=0;x+=1){
    let y;
    if(x<thr){ y=thr+(x-thr)/ratio; }
    else { y=x; }
    let px=(x+60)/60*canvas.width;
    let py=canvas.height-(y+60)/60*canvas.height;
    if(x==-60) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  ctx.strokeStyle="#f00";
  const thrx=(thr+60)/60*canvas.width;
  ctx.beginPath();
  ctx.moveTo(thrx,0);
  ctx.lineTo(thrx,canvas.height);
  ctx.stroke();
}

// fichier audio
document.getElementById("fileInput").addEventListener("change",async(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  if(audioContext) audioContext.close();
  audioContext=new (window.AudioContext||window.webkitAudioContext)();
  const arrayBuffer=await file.arrayBuffer();
  audioBuffer=await audioContext.decodeAudioData(arrayBuffer);
  data=audioBuffer.getChannelData(0);
  drawCombinedWaveform();
});

function playAudio(){
  if(!audioBuffer||isPlaying) return;
  sourceNode=audioContext.createBufferSource();
  sourceNode.buffer=audioBuffer;

  compressorNode=audioContext.createDynamicsCompressor();
  makeupGainNode=audioContext.createGain();
  analyserNode=audioContext.createAnalyser();
  analyserNode.fftSize=2048;

  scriptNode=audioContext.createScriptProcessor(2048,1,1);
  scriptNode.onaudioprocess=function(e){
    const input=e.inputBuffer.getChannelData(0);
    const output=e.outputBuffer.getChannelData(0);
    let reduction=0;
    for(let i=0;i<input.length;i++){
      const x=input[i];
      output[i]=x; // ne change pas le son
      reduction=Math.max(reduction, -compressorNode.reduction.value);
    }
    updateGRMeter(reduction);
  };

  // ROUTING
  sourceNode.connect(compressorNode);
  compressorNode.connect(makeupGainNode);
  makeupGainNode.connect(analyserNode);
  analyserNode.connect(audioContext.destination);

  // scriptNode branché pour tourner en temps réel
  compressorNode.connect(scriptNode);
  scriptNode.connect(audioContext.destination);

  updateCompressor();
  sourceNode.loop=true;
  sourceNode.start();
  isPlaying=true;
  drawLoop();
}
function pauseAudio(){
  if(sourceNode){ sourceNode.stop(); isPlaying=false; cancelAnimationFrame(animationId);}
}

document.getElementById("playBtn").addEventListener("click",playAudio);
document.getElementById("pauseBtn").addEventListener("click",pauseAudio);

function updateGRMeter(db){
  const grFill=document.getElementById("grFill");
  const percent=Math.min(100,Math.max(0,db/20*100));
  grFill.style.height=percent+"%";
}

function drawCombinedWaveform(){
  const canvas=document.getElementById("waveform");
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!data) return;
  const step=Math.floor(data.length/canvas.width);
  const amp=canvas.height/2;
  ctx.strokeStyle="#0f0";
  ctx.beginPath();
  for(let i=0;i<canvas.width;i++){
    const s=Math.floor(i*step);
    let min=1,max=-1;
    for(let j=0;j<step;j++){
      let v=data[s+j];
      if(v<min) min=v;
      if(v>max) max=v;
    }
    ctx.moveTo(i,amp+min*amp);
    ctx.lineTo(i,amp+max*amp);
  }
  ctx.stroke();
}
function drawLoop(){
  drawCombinedWaveform();
  animationId=requestAnimationFrame(drawLoop);
}
</script>
</body>
</html>
